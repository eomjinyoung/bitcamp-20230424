<!DOCTYPE html>
<html>
<head>
    <meta charset='UTF-8'>
    <title>비트캠프</title>
    <link rel="stylesheet" href="/css/common.css">
</head>
<body>

<header class="x-page-header"></header>

<h1>로그인</h1>
<div id="x-message" class="alert alert-error x-hidden">
    이메일 또는 암호가 일치하지 않습니다.
</div>
<form id="x-login-form">
    <table style="border: 1px;">
    <tr>
        <th>이메일</th> <td><input id="x-email" type='text' name='email'></td>
    </tr>
    <tr>
        <th>암호</th> <td><input id="x-password" type='password' name='password'></td>
    </tr>
    </table>
    <span id="x-csrf"></span><br>
    <button>로그인</button>
    <input id="x-saveEmail" type='checkbox' name='saveEmail'> 이메일 저장
    <fb:login-button 
        scope="public_profile,email"
        onlogin="checkLoginState();">
    </fb:login-button>
</form>


<footer class="x-page-footer"></footer>

<script src="/node_modules/axios/dist/axios.min.js"></script>
<script src="/node_modules/jquery/dist/jquery.min.js"></script>
<script src="/node_modules/jquery.cookie/jquery.cookie.js"></script>
<script src="/js/common.js"></script>
<script src="/js/page-init.js"></script>
<script>
    "use strict";

    const loginForm = $("#x-login-form");

    loginForm.find("#x-email").val($.cookie("email"));

    loginForm.submit((e) => { 
        e.preventDefault();
        
        if ($("#x-saveEmail:checked").length > 0) {
            $.cookie("email", $("#x-email").val(), {expires: 7});
        } else {
            $.removeCookie("email", {expires: 7});
        }

        axios.post(`${RESTAPI_HOST}/jwt/token`, {}, {
            auth: {
                username: $("#x-email").val(),
                password: $("#x-password").val()
            },
        })
        .then(response => {
            //console.log(response.data);
            $.cookie("TOKEN", response.data, {path: '/'});
            location.href = "/";
        })
        .catch(error => {
            $.removeCookie("TOKEN", {path: '/'});
            $("#x-message").removeClass("x-hidden");
        });
    });


</script>
<script>
    // 페이스북 자바스크립트 라이브러리 로딩을 완료했을 때 호출될 함수를 등록한다.
    window.fbAsyncInit = function() {
        FB.init({
        appId      : '155080877155279',
        cookie     : true,
        xfbml      : true,
        version    : 'v18.0'
        });
        //FB.AppEvents.logPageView();   
    };

    // 페이스북 자바스크립트 라이브러리를 가져오는 script 태그 추가
    (function(d, s, id){
        var js, fjs = d.getElementsByTagName(s)[0];
        if (d.getElementById(id)) {return;}
        js = d.createElement(s); js.id = id;
        js.src = "https://connect.facebook.net/en_US/sdk.js";
        fjs.parentNode.insertBefore(js, fjs);
    }(document, 'script', 'facebook-jssdk'));

    // 로그인이 성공했을 때 호출된다.
    function checkLoginState() {
        // 페이스북 서버에서 로그인 상태를 가져다 달라고 요청한다.
        FB.getLoginStatus(function(response) {
            if (response.status === 'connected') {
                facebookLogin(response.authResponse.accessToken);
                //console.log(response.authResponse.accessToken);
            } else {
                $.removeCookie("TOKEN", {path: '/'});
                alert("페이스북 로그인 실패!");
            }
        });
    }

    // 페이스북 로그인이 성공한 후 
    // 서버에 페이스북 로그인 처리를 요청한다.
    function facebookLogin(accessToken) {
        axios.post(`${RESTAPI_HOST}/auth/facebookLogin`, accessToken, {
            headers: {
                "Content-Type": "text/plain",
            }
        })
        .then(response => {
            let result = response.data;
            console.log(result);
            $.cookie("TOKEN", result.data, {path: '/'});
            location.href = "/";
        })
        .catch(exception => {
            $.removeCookie("TOKEN", {path: '/'});
            alert("페이스북 로그인 오류!");
            console.log(exception);
        });
    }
</script>
</body>
</html>