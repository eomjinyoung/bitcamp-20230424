<!DOCTYPE html>
<html>
<head>
    <meta charset='UTF-8'>
    <title>게시글</title>
    <link rel="stylesheet" href="/css/common.css">
</head>
<body>

<header class="x-page-header"></header>

<h1>게시글</h1>

<form id="x-board-form" enctype='multipart/form-data'>
    <table border='1'>
    <tr><th style='width:120px;'>번호</th>
    <td style='width:300px;'><input id="x-no" type='text' name='no' value="100" readonly></td></tr>
    <tr><th>제목</th>
    <td><input id="x-title" type='text' name='title' value="제목입니다."></td></tr>
    <tr><th>내용</th>
    <td><textarea id="x-content" name='content' style='height:200px; width:400px;'>내용입니다!</textarea></td></tr>
    <tr><th>작성자</th> <td id="x-writer-name">홍길동</td></tr>
    <tr><th>조회수</th> <td id="x-viewCount">34</td></tr>
    <tr><th>등록일</th> <td id="x-createdDate">2023-09-14</td></tr>
    <tr><th>첨부파일</th><td>
        <div id="x-attachedFiles"></div>
        <input type='file' name='files' multiple>
    </td></tr>
    </table>

    <div>
    <button>변경</button>
    <button  id="x-delete-link" type="button">삭제</a>
    <button type='reset'>초기화</button>
    <a id="x-list-link" href="">목록</a>
    </div>
</form>

<footer class="x-page-footer"></footer>

<script src="/js/common.js"></script>
<script src="/js/page-init.js"></script>
<script>
    "use strict";

    const boardForm = document.querySelector("#x-board-form");
    document.querySelector("#x-list-link").href = `list.html?category=${pageContext.params.category}`;

    (function() {
        const xhr = new XMLHttpRequest();
        xhr.onreadystatechange = () => {
            if (xhr.readyState == 4) {
                if (xhr.status == 200) {
                    var result = JSON.parse(xhr.responseText);
                    console.log(result);
                    if (result.status == "success") {
                        boardForm["x-no"].value = result.data.no;
                        boardForm["x-title"].value = result.data.title;
                        boardForm["x-content"].value = result.data.content;
                        boardForm.querySelector("#x-writer-name").innerHTML = result.data.writer.name;
                        boardForm.querySelector("#x-viewCount").innerHTML = result.data.writer.name;
                        boardForm.querySelector("#x-createdDate").innerHTML = result.data.createdDate;

                        let attachedFiles = document.querySelector("#x-attachedFiles");
                        for (let file of result.data.attachedFiles) {
                            attachedFiles.innerHTML +=  
                                `<a href="https://kr.object.ncloudstorage.com/bitcamp-nc7-bucket-118/board/${file.filePath}">${file.filePath}</a>`
                                + `[<a href="" data-file-no="${file.no}" onclick="fileDelete(event)">삭제</a>]<br>`
                        }
                    } else {
                        alert(result.error);
                    }
                }
            }
        };
        xhr.open("GET" , `${RESTAPI_HOST}/boards/${pageContext.params.category}/${pageContext.params.no}` , true);
        xhr.withCredentials = true;
        xhr.send();
    })();

    boardForm.onsubmit = (e) => {
        e.preventDefault();
        const formData = new FormData(boardForm);
        const xhr = new XMLHttpRequest();
        xhr.onreadystatechange = () => {
            if (xhr.readyState == 4) {
                if (xhr.status == 200) {
                    var result = JSON.parse(xhr.responseText);
                    //console.log(result);
                    if (result.status == "success") {
                        location.href = "list.html?category=" + pageContext.params.category;
                    } else {
                        alert("게시글 변경 오류입니다!");
                    }
                }
            }
        };
        xhr.open("PUT" , `${RESTAPI_HOST}/boards/${pageContext.params.category}/${pageContext.params.no}` , true);
        xhr.withCredentials = true;
        xhr.setRequestHeader("X-XSRF-TOKEN", getCookie("XSRF-TOKEN"));
        xhr.send(formData);
    };

    document.querySelector("#x-delete-link").onclick = () => {
        const no = boardForm["x-no"].value;

        const formData = new FormData();
        const xhr = new XMLHttpRequest();
        xhr.onreadystatechange = () => {
            if (xhr.readyState == 4) {
                if (xhr.status == 200) {
                    var result = JSON.parse(xhr.responseText);
                    //console.log(result);
                    if (result.status == "success") {
                        location.href = "list.html?category=" + pageContext.params.category;
                    } else {
                        alert(result.error);
                    }
                }
            }
        };
        xhr.open("DELETE" , `${RESTAPI_HOST}/boards/${pageContext.params.category}/${pageContext.params.no}`, true);
        xhr.withCredentials = true;
        xhr.setRequestHeader("X-XSRF-TOKEN", getCookie("XSRF-TOKEN"));
        xhr.send(formData);
    };

    function fileDelete(e) {
        e.preventDefault();
        const fileNo = event.target.getAttribute("data-file-no");
        
        const formData = new FormData();
        const xhr = new XMLHttpRequest();
        xhr.onreadystatechange = () => {
            if (xhr.readyState == 4) {
                if (xhr.status == 200) {
                    var result = JSON.parse(xhr.responseText);
                    //console.log(result);
                    
                    if (result.status == "success") {
                        location.href = `detail.html?category=${pageContext.params.category}&no=${pageContext.params.no}`;
                    } else {
                        alert(result.error);
                    }
                }
            }
        };
        xhr.open("DELETE" , `${RESTAPI_HOST}/boards/${pageContext.params.category}/${pageContext.params.no}/files/${fileNo}`, true);
        xhr.withCredentials = true;
        xhr.setRequestHeader("X-XSRF-TOKEN", getCookie("XSRF-TOKEN"));
        xhr.send(formData);
    }

</script>

</body>
</html>













